<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>广点通</title>
<script type="text/javascript">

document.domain = 'qq.com';


 function getTransport( ) {
	// throw new Error();
    var xhr;
    if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
    } else if (window.ActiveXObject) {
        xhr = new ActiveXObject("Msxml2.XMLHTTP") || new ActiveXObject("Microsoft.XMLHTTP");
    }
    return xhr;
};


function getXHR(send, ecb) {
	try {
		xmlHttp = getTransport();
	} catch(e) {
		// 获取xmhttp 对象报错
		ecb({ret: 599, msg: 'get transport error', status: 598, exception: e});
		return;
	}
	
	var clear = function() {
		xmlHttp.onreadystatechange = null;
		xmlHttp = null;
		delete xmlHttp;

		setting.clear && setting.clear();
	};
	
	send(xmlHttp, clear);
}

function xhrgetter(url, callback, ecb, opts) {
	var timer ;
	opts = opts || {};

	var cleartimer = function() {
		if(timer) {
			clearTimeout(timer);
			timer = null;
		}	
	};
	
	var send = function(xmlHttp, clear) {
		xmlHttp.onreadystatechange = function() {
			// console.log('statuschange： readystatus_' , xmlHttp.readyState, ', status_', xmlHttp.status);
			if (xmlHttp.readyState == 4) {
				if (xmlHttp.status == 200) {
					// callback(xmlHttp);
					callback && callback(xmlHttp.responseText);
				} else {
					// http 错误， xmlHttp.status 包含错误码为0 的情况
					ecb({ ret: 599, msg: 'http error',status:  xmlHttp.status});
				}
				cleartimer();
				clear();
			}
		};
		xmlHttp.open("GET", url, true);
		xmlHttp.send(null);
		if (opts.timeout) {
			timer = setTimeout(function() {
				opts.onTimeout && opts.onTimeout();
				cleartimer();
				clear();
			}, opts.timeout);
		}
	}

	getXHR(send, ecb);
};

var setting = frameElement.setting || {};

setting.request && setting.request(xhrgetter);


</script>
</head>
<body></body>
</html>
